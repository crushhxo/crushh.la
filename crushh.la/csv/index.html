<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSV Images to Links</title>
  <style>
    body {
      margin: 0;
      padding: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: #111827;
      color: #f9fafb;
    }
    h1 {
      margin-top: 0;
      font-size: 24px;
    }
    .container {
      max-width: 760px;
      margin: 0 auto;
    }
    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 12px;
    }
    .buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #3b82f6;
      color: #f9fafb;
    }
    button.secondary {
      background: #374151;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .status {
      font-size: 13px;
      color: #d1d5db;
      margin-bottom: 8px;
      min-height: 18px;
    }
    .progress-wrapper {
      height: 10px;
      background: #1f2937;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      transition: width 0.1s linear;
    }
    textarea {
      width: 100%;
      height: 180px; /* ~10 lines */
      resize: vertical;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      padding: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    .how-to {
      font-size: 11px;
      color: #ffffff;
      line-height: 1.4;
      border-top: 1px solid #374151;
      padding-top: 10px;
      margin-top: 8px;
    }
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CSV Images to Links</h1>
    <p class="hint">
      Click “Select Folder…” and choose the folder that contains all your item images.
      They’ll be uploaded directly to Litterbox and you’ll get a list of links to paste into your Google Sheet. Upload links expire after 24h, so make sure to upload your CSV to inventory quickly! Visit the 
  <a 
    href="https://help.whatnot.com/hc/en-us/articles/7440530071821-Bulk-import-products-from-a-CSV-file"
    target="_blank"
    rel="noopener noreferrer"
    style="font-weight: bold; color: #ff4d4d; text-decoration: none;"
  >
    CSV Help Center article
  </a> 
  for the CSV template and inventory upload instructions.
    </p>

    <div class="buttons">
      <button id="selectFolderBtn">Select Folder…</button>
      <button id="copyBtn" disabled>Copy Output</button>
      <button id="downloadTxtBtn" class="secondary" disabled>Download .txt</button>
    </div>

    <div class="status" id="status">Ready.</div>

    <div class="progress-wrapper">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <textarea id="output" placeholder="Uploaded image URLs will appear here (one per line)…" readonly></textarea>

    <div class="how-to">
      <strong>How to use:</strong><br /><br />
      Only supports 1 image per item at a time. Uploads the images in the same order they are inside the folder,
      so take your photos from first item to last item in the CSV.<br /><br />
      1. Upload your images to a new local folder, right click, and choose "Sort by &gt; Name" (on Mac, not sure about Windows folder sorting). This is very important for proper image upload order!<br />
      2. Click “Select Folder…” and choose that folder of images<br />
      3. Wait for the images to upload<br />
      4. Copy the output of image links with the copy button<br />
      5. CMD or CTRL + SHIFT + V to paste the list into your Google Sheet, starting from your first item
    </div>

    <!-- Folder-only file input -->
    <input id="fileInput" type="file" multiple webkitdirectory directory />
  </div>

  <script>
    const selectFolderBtn = document.getElementById('selectFolderBtn');
    const copyBtn = document.getElementById('copyBtn');
    const downloadTxtBtn = document.getElementById('downloadTxtBtn');
    const fileInput = document.getElementById('fileInput');
    const statusEl = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const outputEl = document.getElementById('output');

    const LITTERBOX_URL = 'https://litterbox.catbox.moe/resources/internals/api.php';
    const EXPIRATION = '24h'; // 24h default

    function isImageFile(file) {
      return /\.(jpe?g|png|gif|webp)$/i.test(file.name);
    }

    function setProgress(current, total) {
      const pct = total > 0 ? (current / total) * 100 : 0;
      progressBar.style.width = pct + '%';
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    async function uploadFileToLitterbox(file) {
      const formData = new FormData();
      formData.append('reqtype', 'fileupload');
      formData.append('time', EXPIRATION);
      formData.append('fileToUpload', file);

      const resp = await fetch(LITTERBOX_URL, {
        method: 'POST',
        body: formData,
      });

      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }

      const text = (await resp.text()).trim();
      return text; // Litterbox returns the URL directly
    }

    async function handleFiles(fileList) {
      const files = Array.from(fileList).filter(isImageFile);
      // Sort by name so it matches "Sort by Name" in Finder
      files.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

      if (!files.length) {
        setStatus('No image files found in the selected folder.');
        return;
      }

      copyBtn.disabled = true;
      downloadTxtBtn.disabled = true;
      outputEl.value = '';
      setProgress(0, 1);

      const total = files.length;
      let uploaded = 0;
      const links = [];

      setStatus(`Uploading ${total} images to Litterbox (24h)…`);

      for (const file of files) {
        try {
          setStatus(`Uploading: ${file.name}`);
          const url = await uploadFileToLitterbox(file);
          links.push(url);
        } catch (err) {
          console.error('Upload failed for', file.name, err);
          links.push(`# ERROR uploading ${file.name}`);
        }
        uploaded += 1;
        setProgress(uploaded, total);
      }

      outputEl.value = links.join('\n');
      copyBtn.disabled = links.length === 0;
      downloadTxtBtn.disabled = links.length === 0;
      setStatus(`Done. Uploaded ${total} images. Output ready to copy.`);
    }

    // Open folder picker
    selectFolderBtn.addEventListener('click', () => {
      fileInput.value = ''; // reset so same folder can be chosen repeatedly
      fileInput.click();
    });

    // When a folder is selected
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files.length) {
        handleFiles(e.target.files);
      } else {
        setStatus('No folder selected.');
      }
    });

    // Copy output
    copyBtn.addEventListener('click', async () => {
      const text = outputEl.value;
      if (!text.trim()) return;
      try {
        await navigator.clipboard.writeText(text);
        setStatus('Output copied to clipboard.');
      } catch (err) {
        console.error('Clipboard error:', err);
        setStatus('Could not access clipboard. You may need to copy manually.');
      }
    });

    // Download .txt
    downloadTxtBtn.addEventListener('click', () => {
      const text = outputEl.value;
      if (!text.trim()) return;

      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'uploaded_image_links.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      setStatus('Downloaded uploaded_image_links.txt');
    });
  </script>
</body>
</html>